

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Trust noone</title>
    <meta name="description" content="Let's fix some parts of the code that are too credulous.">
    <meta name="author" content="BYO">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="/assets/themes/midnight/css/ie.css">
    <![endif]-->
    <link href="/assets/themes/midnight/css/styles.css" rel="stylesheet">
    <link href="/assets/themes/midnight/css/pygment_trac.css" rel="stylesheet" type="text/css" media="all">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="/assets/themes/midnight/js/respond.js"></script>

    <!-- Le fav and touch icons -->
  <!-- Update these with your own img
    <link rel="shortcut icon" href="img/favicon.ico">
    <link rel="apple-touch-icon" href="img/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="img/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="img/apple-touch-icon-114x114.png">
  -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  </head>

  <body>

    <div id="header">
      <nav>
        <li class="title"><h1><a href="/">Cinode dev blog</a></h1></li>
        
        
        


  
    
      
      	
      	<li><a href="/archive">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags">Tags</a></li>
      	
      
    
  



      </nav>
    </div>

    <div class="wrapper">

      <div class="content">
        

<div class="wrapper">
  <section>
    <div id="title">
      <h1>Trust noone</h1>
      
      <br><hr>
      <span class="credits left">Written by: <a href="">BYO</a></span>
      <span class="credits right">Last updated: 2016-09-27 00:00:00 +0200</span>
    </div>
    
<h1 id="where-things-went-wrong">Where things went wrong?</h1>

<p>Let’s solve the “puzzle” from last post, shall we?</p>

<p>The issue was with the trust level. The code basically assumed that the storage layer being a memory, filesystem or a remote web server is trustworthy. When the data was read back from datastore, the code didn’t check whether it’s correct or not. And from the design point of view we know that the data must perfectly match the name of blob we asked for.</p>

<p>We could argue about the in-memory implmentation which should be secure as long as someone or something doesn’t mess up with the memory of our process (sometimes <a href="https://en.wikipedia.org/wiki/Data_degradation">it happens</a> unintentionally). But when files are stored on the local HDD, it’s much easier to alter them. The least secure of all three implementations was the web connector one. Connecting it to a bogus server would basically break our security since any blob could be replaced with anything else.</p>

<p>So what’s the fix? You can see all changes I made <a href="https://github.com/cinode/go/pull/9/files">here</a>, but they can be summarized as:</p>

<ol>
  <li>When reading data from any public interface implementation, always check if the contents <a href="https://github.com/cinode/go/blob/v2016-09-27/datastore/common.go#L33">does match given blob name</a></li>
  <li>In case of web connector, <a href="https://github.com/cinode/go/blob/v2016-09-27/datastore/webconnector.go#L90">check what name is generated when calling SaveAutoNamed</a> - it’s to ensure the server we’re connecting to does produce valid blob names</li>
  <li>A bonus one (not directly connected to trust problems but still being a security issue) - when comparing blob names, <a href="https://github.com/cinode/go/blob/v2016-09-27/datastore/common.go#L11">use constant-time comparision</a> - this could prevent exposure of raw blob names in case we want to hide them on higher levels</li>
</ol>

<p>After those changes, it’s now required for the <code>datastore</code> interface to return a valid data for given blob name or fail with an error so the consumer of this interface can assume no error means valid data.</p>

<h1 id="lets-play-the-bad-guy">Let’s play the bad guy</h1>

<p>Ok, let’s think now how the trust issue could be exploited. If we assume that the attacker has full access to the storage (i.e. access to files in case of file-based datastore), he could basically inject any contents he want to whoever is using the datastore.</p>

<p>In case of plaintext data the result is pretty devastating - i.e. replacement of some javascript on a statically-served web page with a malicious version. Once the attacker can inject his own code into victim’s computer, the fight is over.</p>

<p>One may think though that if the data stored in datastore is encrypted, we’re in a much better position, the attacker wouldn’t be able to inject his own ciphertext without the knowledge of the key, right? Nothing further from the truth, this is known as <a href="https://en.wikipedia.org/wiki/Chosen-ciphertext_attack">chosen ciphertext attack</a>. Results could be as devastating as in case of plaintext stored in the datastore, there would be no integrity of data.</p>

<p>That’s it for today. Hope to write something more soon.</p>

    <hr>
    <div style="text-align: center;">
      <span style="float: left;">
        
          <a href="/2016/09/12/encrypt-em-all" title="Encrypt 'em all">&larr; Previous</a>
        
      </span>
      <span>
        <a href="/archive.html">Archive</a>
      </span>
      <span style="float: right;">
        
          <a href="/2016/10/03/we-need-trees-we-need-graphs" title="We need trees, we need graphs">Next &rarr;</a>
        
      </span>
      </nav>
    </div>
    <div id="tags">
      <br>
      
        Tags: 
        <ul style="display: inline; padding-left: 10px;">
        
        


  
     
    	<li><a href="/tags.html#golang-ref">golang <span>4</span></a></li>
     
    	<li><a href="/tags.html#programming-ref">programming <span>4</span></a></li>
     
    	<li><a href="/tags.html#encryption-ref">encryption <span>3</span></a></li>
     
    	<li><a href="/tags.html#prototype-ref">prototype <span>4</span></a></li>
     
    	<li><a href="/tags.html#bugfix-ref">bugfix <span>1</span></a></li>
    
  



        </ul>
      
    </div>
  </section>
  <section>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    
    var disqus_developer = 1;
    var disqus_shortname = 'cinodeblog'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </section>
</div>



      </div>

      <footer>
        <p>&copy; BYO 2016
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
        </p>
      </footer>

    </div> <!-- /container -->
    



  </body>
</html>

