

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>CAS in action</title>
    <meta name="description" content="Let's see some first code. In this post I'll show you a prototype implementation of CAS layer.">
    <meta name="author" content="BYO">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="/assets/themes/midnight/css/ie.css">
    <![endif]-->
    <link href="/assets/themes/midnight/css/styles.css" rel="stylesheet">
    <link href="/assets/themes/midnight/css/pygment_trac.css" rel="stylesheet" type="text/css" media="all">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="/assets/themes/midnight/js/respond.js"></script>

    <!-- Le fav and touch icons -->
  <!-- Update these with your own img
    <link rel="shortcut icon" href="img/favicon.ico">
    <link rel="apple-touch-icon" href="img/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="img/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="img/apple-touch-icon-114x114.png">
  -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  </head>

  <body>

    <div id="header">
      <nav>
        <li class="title"><h1><a href="/">Cinode dev blog</a></h1></li>
        
        
        


  
    
      
      	
      	<li><a href="/archive">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags">Tags</a></li>
      	
      
    
  



      </nav>
    </div>

    <div class="wrapper">

      <div class="content">
        

<div class="wrapper">
  <section>
    <div id="title">
      <h1>CAS in action</h1>
      
      <br><hr>
      <span class="credits left">Written by: <a href="">BYO</a></span>
      <span class="credits right">Last updated: 2016-07-26 00:00:00 +0200</span>
    </div>
    
<h1 id="tough-decisions">Tough decisions</h1>

<p>Before I jump to description of the code itself, let’s first clarify what
technology I’ll be using to write Cinode prototype. I decided to use
<a href="https://golang.org/">golang</a>. I find it rather nice to work with but it also
has some thorns here and there. Why would I like to use it then? It turns out to
be very practical, especially in the field of network services. Goroutines are
just great - no need to think in terms of callbacks anymore, just straight,
sequential code.</p>

<p>Golang also has everything we’ll need to build the prototype - all crypto
primitives and nice toolset for a http-based services. I don’t expect this
prototype to be a performance rocket but the speed that golang would give us
should be enough.</p>

<p>I must also admit that I don’t yet care to much about cross-process memory
safety. There will be a lot of keys and passphrases in the memory but we don’t
want to protect against attacker who can read that, it’s still a prototype,
right? Keeping that in mind, golang is just a perfect match here.</p>

<p>I’ll be developing on Linux platform - that’s my primary OS but I’ll try not to
use any os-specific constructs. Of course I strongly recommend Linux for any
project dealing with network, especially if it supports our freedom. But I won’t
force you to use it. Freedom to choose what you want is something I do respect.
If for some reason this project won’t work well on other OS-es, please keep in
ming that this wasn’t intentional. I also kindly ask you to <a href="https://github.com/cinode/go/issues/new">let me know about
it</a>.</p>

<p>To avoid such OS misbehavior and to have good quality of the codebase, I’ll do
test driven development, maybe not in it’s strict sense, but my goal is to have
everything well tested. Golang has very good support for testing and coverage
reports so we’ll save some time to setup correct tools.</p>

<p>The source code will be stored in <a href="https://github.com/cinode/go">github
repository</a>, tests will be done through <a href="https://travis-ci.org/cinode/go">Travis
CI</a>. Coverage analysis will be done using
<a href="https://coveralls.io/github/cinode/go">Coveralls</a>. I decided to use those tools
to get most of the stuff running up quickly. Even though I had some initial
issues with setting everything up, the time win is huge here. Besides, having
everything public in public tools creates higher pressure to keep high level of
quality from the beginnig.</p>

<h1 id="lets-have-some-baseline">Let’s have some baseline</h1>

<p>Before any serious code was put down, I’ve set few rules I wanted to follow:</p>

<ul>
  <li>Build clean layered architecture - split the system into layers (matching<br />
Cinode’s design). Each layer should be a separate module with it’s own
namespace in go.</li>
  <li>Each module must have a clear set of interfaces it provides to communicate
with other modules and application code.</li>
  <li>Each module’s interface must have apriopriate set of test cases covering
all interface methods</li>
  <li>For each module there should be a reference implementation of it’s
interfaces - such implementation does not have to store data permanently
between sessions. It will be used during testing as a reference behavior of
the interface.</li>
  <li>If there are multiple implemetnations of the module interfce, all interface
tests must be executed on all interface implementations and pass cleanly.
Additional tests should be used to cover corner cases of specific interface
implementations.</li>
  <li>I opt for high code coverage from the beginning. Although it does not prove
that the code is bug-free, it would at least ensure most of code paths were
executed while testing.</li>
</ul>

<p>Enough of boring talk, let’s have some code!</p>

<h1 id="cas-interface">CAS interface</h1>

<p>I first started with <a href="https://github.com/cinode/go/blob/v2016-07-29/cas/interface.go">draft
interface</a>. In
CAS we need some obvious functionality: uploading blob and downloading existing
one. We also need to delete existing blob and check if one does exist. I also
knew I wouldn’t use buffers to specify data of blobs, streams would fit much
better here - that way we can put and get blobs of arbitrary size without
worrying about the amount of consumed memory.</p>

<p>I started with a trivial implementation that was storing data <a href="https://github.com/cinode/go/blob/v2016-07-29/cas/memory.go">inside
memory</a>. It was my
base when I was writing <a href="https://github.com/cinode/go/blob/v2016-07-29/cas/interface_test.go">interface
tests</a>.</p>

<p>Once I felt I have enough of the interface covered, I started working on
more practical implementation storing data on <a href="https://github.com/cinode/go/blob/v2016-07-29/cas/filesystem.go">local
filesystem</a>.
During implementation I also made small change to the interface - I split
uploading blob into two separate functions. First would be used to upload blob
when it’s name is known - such uplaod would fail if name does not match the
contents. I also made an alternative method where we only give data and get the
calculated name back.</p>

<p>When everything was up and running I wanted to add one more functionality to the
module. In order to make first usable application I wanted to let us play with
cas using plain web browser. For this purpose I made <a href="https://github.com/cinode/go/blob/v2016-07-29/cas/webinterface.go">web
interface</a>.
It’s purpose is to take any implementation of CAS interface and some
configuration and expose CAS functionality through http. Implementation worked
like a charm. It is very simple and follows REST design:</p>

<ul>
  <li>GET reads a blob</li>
  <li>POST uploads new blob if we don’t know the name</li>
  <li>PUT uploads blob if we know the name</li>
  <li>DELETE removea blob</li>
  <li>HEAD finds out if blob exists</li>
</ul>

<p>Initially POST and PUT were taking raw post data as post body. I extended it
later to also support mnultipart/form-data content types to allow uploading from
HTML form.</p>

<p>Once the Web Interface was ready, I needed an easy way to test it. What would
perfectly make sense here is a new implementation of CAS interface that talks to
some remotely available Web backend with compatible protocol (so a web
interface). Once I did it I could use common interface testing code. Tests were
run on CAS implementation which connected to local web interface. This web
interface on then was attached to local memory-based implementation.</p>

<h1 id="lets-make-it-practical">Let’s make it practical</h1>

<p>Ok, we have all those blocks of code but none of them is any useful standalone
application yet. Just bunch of code inside cas library which can’t be used
without writing some go code. We can expose CAS through HTTP, so I created a
<a href="https://github.com/cinode/go/blob/v2016-07-29/cas/cmd/cinode_cas_fileserver/main.go">simple
application</a>
that exposes data from a local directory (so filesystem-based CAS
implementation) in a form of a simple web server. Let’s give it a try:</p>

<pre><code class="language-sh"># Fetch and compile server binary
go install github.com/cinode/go/cas/cmd/cinode_cas_fileserver

# Start the server, configuration is passed through environmental variables
CN_CAS_LISTEN_ADDR=127.0.0.1:8080 \
CN_CAS_DATA_FOLDER=/tmp/cinode/ \
  $GOPATH/bin/cinode_cas_fileserver
</code></pre>

<p>In a separate shell:</p>

<pre><code class="language-sh"># Upload some data blob (extra echo needed since CAS server doesn't output
# newline character)
curl -d "Hello world!" http://127.0.0.1:8080/; echo
# Will output: XB5P3GWTHnHTud55BijFsGmBjHZtwtc44es4HsZnqMGM

# Download the blob (extra echo needed for reasons same as above)
curl http://127.0.0.1:8080/XB5P3GWTHnHTud55BijFsGmBjHZtwtc44es4HsZnqMGM; echo
# Will output: Hello world!

# Upload some file
echo "Hello world from a file" &gt; /tmp/upload_file.txt
curl --form "fileupload=@/tmp/upload_file.txt;filename=file.txt" \
  http://127.0.0.1:8080/; echo
# Will output: WHa8NVuf1RfUVrqsyqmo2Vh1xyuVTqJqJePhjSxHwZmy

# Download the blob (no need for extra echo since the uploaded file had newline)
curl http://127.0.0.1:8080/WHa8NVuf1RfUVrqsyqmo2Vh1xyuVTqJqJePhjSxHwZmy
# Will output: Hello world from a file
</code></pre>

<p>A small note about those strange blob names - they don’t look like hex string
nor base64-encoded values. Instead I decided to use
<a href="https://en.wikipedia.org/wiki/Base58">Base58</a> - it’s commonly used in BitCoin
and encodes any binary data to a string that always consists of alphanumeric
characters - a perfect selection if we don’t want to deal with encoding
incompatibilities in the future. This encoding may not be very fast but our blob
names are not that long anyway.</p>

<p>Ok, once we have a web server and can upload some data into it, maybe we should
make some more practical use of it? First let’s try to use CAS as a storage for
html pages:</p>

<pre><code class="language-sh">curl -d '&lt;!doctype html&gt;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello world!&lt;/h1&gt;&lt;/html&gt;' \
  http://127.0.0.1:8080/; echo
# Will output: QH9EmJveKGD1ppUgDVjBqZ8XKw4crBuSNHApgjK9RbgR

# Open in web browser
x-www-browser http://127.0.0.1:8080/QH9EmJveKGD1ppUgDVjBqZ8XKw4crBuSNHApgjK9RbgR
</code></pre>

<p>I also made a simple dataset with html that lets you upload files directly from the web browser:</p>

<pre><code class="language-sh">git clone https://github.com/cinode/testdata-cas-filesystem.git /tmp/test-data
cd /tmp/test-data
git checkout v2016-07-29
CN_CAS_LISTEN_ADDR=127.0.0.1:8080 \
CN_CAS_DATA_FOLDER=/tmp/test-data/ \
  $GOPATH/bin/cinode_cas_fileserver
</code></pre>

<pre><code class="language-sh">x-www-browser http://127.0.0.1:8080/bR9AEqo79uoYLoGx2Xf1JViBbTz5aZWBy9qkHMZxeWYM
</code></pre>

<p>That’s it for today. Apart from CAS there’s still an encryption layer to be implemented. I hope to cover it in next post.</p>

<p>Bye</p>

    <hr>
    <div style="text-align: center;">
      <span style="float: left;">
        
          <a href="/2016/06/18/password-please" title="Password please">&larr; Previous</a>
        
      </span>
      <span>
        <a href="/archive.html">Archive</a>
      </span>
      <span style="float: right;">
        
          <a>Next &rarr;</a>
        
      </span>
      </nav>
    </div>
    <div id="tags">
      <br>
      
        Tags: 
        <ul style="display: inline; padding-left: 10px;">
        
        


  
     
    	<li><a href="/tags.html#golang-ref">golang <span>1</span></a></li>
     
    	<li><a href="/tags.html#programming-ref">programming <span>1</span></a></li>
     
    	<li><a href="/tags.html#cas-ref">cas <span>3</span></a></li>
     
    	<li><a href="/tags.html#prototype-ref">prototype <span>1</span></a></li>
    
  



        </ul>
      
    </div>
  </section>
  <section>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    
    var disqus_developer = 1;
    var disqus_shortname = 'cinodeblog'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </section>
</div>



      </div>

      <footer>
        <p>&copy; BYO 2016
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
        </p>
      </footer>

    </div> <!-- /container -->
    



  </body>
</html>

